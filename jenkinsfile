#!/bin/bash

pipeline {
  agent any

  stages {
    stage('install app1 to host1') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws_cred', passwordVariable: 'AWS_SECRET_ACCESS_KEY', usernameVariable: 'AWS_ACCESS_KEY_ID')]) {
          sh """
          cd app1/vars/
          pwd         
          echo "$AWS_SECRET_ACCESS_KEY" >> aws_access_key.yml
          echo "$AWS_ACCESS_KEY_ID" >> aws_access_key.yml        
          chmod 400 2CB.pem
          ansible-playbook -i hosts main.yml
          """
        }
      }
    }

    stage('install app2 to host2'){
      steps {
        sh """
        pwd
        cd app2/
        chmod 400 2CB.pem
        ansible-playbook -i hosts main.yml
        """
      }
    }
  }
}

